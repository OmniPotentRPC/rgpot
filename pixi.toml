[workspace]
authors = ["Rohit Goswami <rgoswami@ieee.org>"]
channels = ["conda-forge"]
description = "RPC based core for potential energy surface functionality."
name = "rgpot"
platforms = ["win-64", "linux-64", "osx-64", "osx-arm64"]
version = "0.1.0"

[feature.cigen.tasks]
gen-gha = { cmd = "nickel export --format yaml ci/gha/workflow.ncl -o .github/workflows/build.yml" }

[environments]
rpctest = {features = ["rpc", "itests"]}
cigen = {features = ["cigen"]}
devbld = { features = ["rpc", "cache"] }
docs = { features = ["docs"]}

[feature.cache.dependencies]
rocksdb = ">=10.9.1,<11"
xxhash = ">=0.8.3,<0.9"

[feature.rpc.dependencies]
capnproto = ">=1.0.2,<2"

[feature.cigen]
platforms = ["linux-64"]

[feature.cigen.dependencies]
nickel = ">=9.9.9,<10"

[feature.itests.dependencies]
pycapnp = ">=2.0.0,<3"
ipython = ">=8.28.0,<9"
pip = ">=24.2,<25"
numpy = ">=2.4.1,<3"

[feature.docs]
# doxyrest only works on linux
platforms = ["linux-64"]

[feature.docs.dependencies]
doxygen = ">=1.13.2,<2"
sphinx = ">=8.2.3,<9"
doxyrest = ">=2.1.2,<3"
emacs = ">=30.2,<31"
pandoc = ">=3.1,<4"

[feature.docs.pypi-dependencies]
sphinx-sitemap = ">=2.9.0, <3"
shibuya = ">=2026.1.9, <2027"
pycmark = ">=0.9.6, <0.10"
sphinxcontrib-rust = ">=1.0.0, <2"
sphinx-rustdoc-postprocess = ">=0.1.0, <0.2"

[dependencies]
compilers = ">=1.8.0,<2"
meson = ">=1.5.2,<2"
cmake = ">=3.30.4,<4"
pkgconfig = ">=1.5.5,<2"
openblas = ">=0.3.28,<0.4"
xtensor = ">=0.27.1,<0.28"
eigen = ">=3.4.0,<4"
fmt = ">=11.0.2,<12"
spdlog = ">=1.14.1,<2"
catch2 = ">=3.7.1,<4"
cppcheck = ">=2.15.0,<3"
cpplint = ">=1.6.0,<2"
fortran-compiler = ">=1.8.0,<2"
clang-format = ">=19.1.0,<20"
pkgconf = ">=2.5.1,<3"
zlib = ">=1.3.1,<2"
xtensor-blas = ">=0.23.0,<0.24"
ccache = ">=4.12.2,<5"
rust = ">=1.75.0"
cargo-nextest = ">=0.9.86"
uv = ">=0.6.0"
# cbindgen cannot be installed with pixi here

[tasks]
rust-test = { cmd = "cargo nextest run --manifest-path rgpot-core/Cargo.toml", description = "Run Rust core unit tests with nextest" }
rust-test-all = { cmd = "cargo nextest run --manifest-path rgpot-core/Cargo.toml --all-features", description = "Run Rust core tests with all features enabled" }
gen-header = { cmd = "cargo build --manifest-path rgpot-core/Cargo.toml --features gen-header", description = "Regenerate C header (include/rgpot.h) from Rust source" }
towncrier-draft = { cmd = "uvx towncrier build --draft", description = "Preview release notes" }
towncrier-build = { cmd = "uvx towncrier build", description = "Build release notes into CHANGELOG.md" }

[feature.docs.tasks.gen-readme]
description = "Export rgpot-core/README.org to README.md"
cmd = "emacs --batch rgpot-core/README.org --eval '(require (quote ox-md))' --eval '(org-md-export-to-markdown)'"

[feature.docs.tasks.docbld]
depends-on = [
"mkrst",
"doxybuild",
"sphinxbld",
]

[feature.docs.tasks.setup-doxyrest]
description = "Clones the doxyrest dependency into the subprojects directory"
cmd = "test -d subprojects/doxyrest || (mkdir -p subprojects && git clone --depth 1 --single-branch https://github.com/vovkos/doxyrest subprojects/doxyrest)"

[feature.docs.tasks.patch-doxyrest]
description = "Apply temporary fixes for documentation"
depends-on = ["setup-doxyrest"]
cmd = """
cp scripts/patches/doxyrest/doxyrest.py subprojects/doxyrest/sphinx/doxyrest.py &&
patch -p1 -N -s < scripts/patches/doxyrest/enum_class_fix.patch || true
"""

[feature.docs.tasks.mkrst]
cwd = "docs"
cmd = "emacs --batch --load export.el"

[feature.docs.tasks.doxybuild]
description = "Generates XML via Doxygen and converts it to RST via Doxyrest"
cwd = "docs/source"
depends-on = ["patch-doxyrest"]
cmd = "doxygen Doxyfile_potlib.cfg && doxyrest -c doxyrest-config.lua"


[feature.docs.tasks.setup-rustdocgen]
description = "Install sphinx-rustdocgen binary for Rust API documentation"
cmd = "cargo install sphinx-rustdocgen"

[feature.docs.tasks.sphinxbld]
depends-on = [
{ task = "mkrst", environment = "docs" },
"setup-rustdocgen",
]
cmd = """
sphinx-build -d docs/doctrees docs/source/ docs/build
"""

[feature.docs.tasks.docdel]
cwd = "docs"
# removes files generated by doxygen, sphinx and orgmode
cmd = """
rm -rf build
rm -rf doctrees
rm -rf source/xml
rm -rf source/api
rm -rf source/crates
rm -rf source/contributing
rm -rf source/*.rst
"""
