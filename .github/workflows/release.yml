name: Release
on:
  push:
    tags: ["v*"]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: prefix-dev/setup-pixi@v0.8.10
        with:
          activate-environment: true
          environments: devbld

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with: { tool: cargo-nextest }

      - name: Run Rust tests
        run: |
          cargo nextest run --manifest-path rgpot-core/Cargo.toml --all-features
          cargo test --doc --manifest-path rgpot-core/Cargo.toml
        shell: pixi run bash -e {0}

      - name: Cargo publish
        run: cargo publish --manifest-path rgpot-core/Cargo.toml
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Extract changelog for this version
        id: changelog
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          # Extract the section for this version from CHANGELOG.md
          awk "/^## \[${VERSION}\]/,/^## \[/" CHANGELOG.md | head -n -1 > /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: /tmp/release_notes.md
          generate_release_notes: false
