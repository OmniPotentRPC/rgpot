concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  build_and_test:
    env:
      CCACHE_COMPILERCHECK: content
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 500M
    name: ${{ matrix.sys }} [RPC:${{ matrix.rpc }} CACHE:${{ matrix.cache }}]
    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    - uses: prefix-dev/setup-pixi@v0.8.1
      with:
        cache: true
        pixi-version: v0.62.1
    - uses: astral-sh/setup-uv@v7
      with:
        activate-environment: true
        enable-cache: true
    - name: Restore Compiler Cache
      uses: actions/cache@v4
      with:
        key: ccache-${{ runner.os }}-${{ matrix.sys }}-${{ github.sha }}
        path: .ccache
        restore-keys: ccache-${{ runner.os }}-${{ matrix.sys }}-
    - if: ${{ matrix.sys == 'meson' }}
      name: Build & Test (Meson)
      run: |-
        meson setup bbdir \
          -Dwith_tests=True \
          -Dwith_examples=False \
          -Dwith_xtensor=False \
          -Dwith_eigen=False \
          -Dwith_rpc=${{ matrix.rpc }} \
          -Dwith_cache=${{ matrix.cache }} \
          -Dpure_lib=False
        meson compile -C bbdir
        meson test -C bbdir --print-errorlogs
        ccache -s
      shell: pixi run bash -e {0}
    - if: ${{ matrix.sys == 'cmake' }}
      name: Build & Test (CMake)
      run: |-
        cmake -S . -B build \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_BUILD_TYPE=Release \
          -DPOTLIB_BUILD_TESTS=True \
          -DPOTLIB_BUILD_EXAMPLES=False \
          -DPOTLIB_WITH_XTENSOR=OFF \
          -DPOTLIB_WITH_EIGEN=OFF \
          -DPOTLIB_WITH_RPC=${{ matrix.rpc }} \
          -DPOTLIB_WITH_CACHE=${{ matrix.cache }} \
          -DPOTLIB_PURE_LIB=OFF
        cmake --build build -j
        ctest --test-dir build --output-on-failure
        ccache -s
      shell: pixi run bash -e {0}
    - if: ${{ matrix.rpc == 'true' }}
      name: RPC Integration Test
      run: |-
        uv pip install numpy pycapnp
        uv run python tests/rpc_integ.py --server-bin ${{ matrix.sys == 'meson' && 'bbdir/CppCore/rgpot/rpc/potserv' || 'build/potserv' }}
      shell: pixi run bash -e {0}
    strategy:
      fail-fast: false
      matrix:
        cache:
        - 'true'
        - 'false'
        os:
        - ubuntu-latest
        - macos-latest
        rpc:
        - 'true'
        - 'false'
        sys:
        - meson
        - cmake
  client_bridge_stress:
    env:
      CCACHE_COMPILERCHECK: content
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    name: Client Bridge Stress Test (Linux)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    - uses: prefix-dev/setup-pixi@v0.8.1
      with:
        cache: true
        pixi-version: v0.62.1
    - name: Restore Compiler Cache
      uses: actions/cache@v4
      with:
        key: ccache-${{ runner.os }}-${{ matrix.sys }}-${{ github.sha }}
        path: .ccache
        restore-keys: ccache-${{ runner.os }}-${{ matrix.sys }}-
    - run: |-
        echo "--- Building Server (Heavy) ---"
        meson setup bbdir_server \
              -Dwith_rpc=true \
              -Dwith_tests=false \
              -Dwith_examples=false
        meson compile -C bbdir_server
      shell: pixi run bash -e {0}
    - run: |-
        echo "--- Building Client Bridge (Light) ---"
        cmake -S . -B build_client \
              -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
              -DCMAKE_C_COMPILER_LAUNCHER=ccache \
              -DCMAKE_BUILD_TYPE=Release \
              -DPOTLIB_RPC_CLIENT_ONLY=ON \
              -DPOTLIB_BUILD_TESTS=ON
        cmake --build build_client -j
      shell: pixi run bash -e {0}
    - run: |-
        echo "--- Starting Server ---"
        # Start server in background on port 12345 using LJ potential
        ./bbdir_server/CppCore/rgpot/rpc/potserv 12345 LJ &
        SERVER_PID=$!

        # Wait for server to be ready
        sleep 2

        echo "--- Running Client Stress Tests ---"
        # This runs BridgeStressTest, which connects to localhost:12345
        ctest --test-dir build_client --output-on-failure

        echo "--- Teardown ---"
        kill $SERVER_PID
      shell: pixi run bash -e {0}
name: Build Matrix
on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
